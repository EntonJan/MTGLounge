<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Online Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body, html { height: 100%; overflow: hidden; }
        .input-dark { @apply bg-gray-700 border border-gray-600 p-2 rounded w-full text-white; }
        .mana-symbol { width: 1.5rem; height: 1.5rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; }
        .mana-selected { border-color: white; transform: scale(1.2); }
        .mana-w { background: #F9F3B7; color: black; } .mana-u { background: #3A62B7; color: white; }
        .mana-b { background: #1E1E1E; color: white; } .mana-r { background: #D64242; color: white; } .mana-g { background: #5B9567; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">
    
    <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-yellow-500"></div>
    </div>

    <div id="app-content" class="hidden flex flex-col h-full">
        <header class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
            <h1 class="text-xl font-bold text-green-400">Online Tracker</h1>
            <button onclick="window.location.href='homescreen.html'" class="p-2 bg-gray-700 rounded-full"><i data-lucide="home" class="w-5 h-5"></i></button>
        </header>

        <div class="flex-grow overflow-y-auto p-4 max-w-2xl mx-auto w-full">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 border border-gray-700">
                <form id="matchForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">My Deck</label>
                            <input type="text" id="ownDeckName" class="input-dark" required placeholder="Deck Name" />
                            <div class="flex gap-1 mt-2" id="own-colors">
                                <div class="mana-symbol mana-w" data-c="W">W</div><div class="mana-symbol mana-u" data-c="U">U</div><div class="mana-symbol mana-b" data-c="B">B</div><div class="mana-symbol mana-r" data-c="R">R</div><div class="mana-symbol mana-g" data-c="G">G</div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Opponent</label>
                            <input type="text" id="opponentDeckName" class="input-dark" required placeholder="Archetype" />
                            <div class="flex gap-1 mt-2" id="opp-colors">
                                <div class="mana-symbol mana-w" data-c="W">W</div><div class="mana-symbol mana-u" data-c="U">U</div><div class="mana-symbol mana-b" data-c="B">B</div><div class="mana-symbol mana-r" data-c="R">R</div><div class="mana-symbol mana-g" data-c="G">G</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1"><label class="text-xs">Wins</label><input type="number" id="wins" class="input-dark" value="0" min="0"></div>
                        <div class="flex-1"><label class="text-xs">Losses</label><input type="number" id="losses" class="input-dark" value="0" min="0"></div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 py-2 rounded font-bold hover:bg-green-500">Log Match</button>
                </form>
            </div>
            
            <h3 class="font-bold mb-2">History</h3>
            <div id="history" class="space-y-2 pb-10"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB2qmkKq4sYOXDd7mF-Mq1rnCWCfDAWXew", authDomain: "entons-game-tracker.firebaseapp.com", projectId: "entons-game-tracker", storageBucket: "entons-game-tracker.firebasestorage.app", messagingSenderId: "968932411080", appId: "1:968932411080:web:d391ffe5ecbd7852bc47fd", measurementId: "G-KB6JSFEPS1" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let user = null;
        let colors = { own: [], opp: [] };

        onAuthStateChanged(auth, (u) => {
            if(!u) window.location.href='index.html';
            user = u;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            lucide.createIcons();
            loadMatches();
        });

        const toggle = (el, type) => {
            const c = el.dataset.c;
            el.classList.toggle('mana-selected');
            if(colors[type].includes(c)) colors[type] = colors[type].filter(x=>x!==c);
            else colors[type].push(c);
        };

        document.querySelectorAll('#own-colors .mana-symbol').forEach(el => el.onclick = () => toggle(el, 'own'));
        document.querySelectorAll('#opp-colors .mana-symbol').forEach(el => el.onclick = () => toggle(el, 'opp'));

        document.getElementById('matchForm').onsubmit = async (e) => {
            e.preventDefault();
            const wins = parseInt(document.getElementById('wins').value);
            const losses = parseInt(document.getElementById('losses').value);
            await addDoc(collection(db, 'users', user.uid, 'mtg_matches'), {
                ownDeckName: document.getElementById('ownDeckName').value,
                opponentDeckName: document.getElementById('opponentDeckName').value,
                ownColors: colors.own, opponentColors: colors.opp,
                wins, losses, result: wins > losses ? 'Win' : 'Loss',
                timestamp: Date.now()
            });
            e.target.reset();
            document.querySelectorAll('.mana-selected').forEach(el => el.classList.remove('mana-selected'));
            colors = { own: [], opp: [] };
        };

        const loadMatches = () => {
            onSnapshot(query(collection(db, 'users', user.uid, 'mtg_matches'), orderBy('timestamp', 'desc')), snap => {
                document.getElementById('history').innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const color = m.result === 'Win' ? 'border-green-500' : 'border-red-500';
                    return `<div class="bg-gray-800 p-3 rounded border-l-4 ${color} shadow flex justify-between items-center">
                        <div>
                            <div class="font-bold text-sm">${m.ownDeckName} vs ${m.opponentDeckName}</div>
                            <div class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleDateString()}</div>
                        </div>
                        <div class="font-bold text-lg">${m.wins}-${m.losses}</div>
                    </div>`;
                }).join('');
            });
        };
    </script>
</body>
</html>