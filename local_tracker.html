<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Local Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Verhindert das Scrollen der ganzen Seite - nur Inhalt scrollt */
        body, html { height: 100%; overflow: hidden; overscroll-behavior: none; }
        
        .input-dark { @apply bg-gray-700 border border-gray-600 p-2 rounded w-full text-white focus:border-yellow-500 focus:outline-none; }
        .select-dark { @apply bg-gray-700 border border-gray-600 p-2 rounded w-full text-white focus:border-yellow-500 focus:outline-none; }
        
        /* Mana Symbole */
        .mana-symbol { width: 1.75rem; height: 1.75rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; font-size: 0.75rem; font-weight: bold; user-select: none; transition: all 0.2s; }
        .mana-selected { border-color: white; transform: scale(1.1); box-shadow: 0 0 8px rgba(255,255,255,0.3); }
        
        .mana-w { background: #F9F3B7; color: #333; } 
        .mana-u { background: #3A62B7; color: white; }
        .mana-b { background: #1E1E1E; color: white; } 
        .mana-r { background: #D64242; color: white; } 
        .mana-g { background: #5B9567; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">
    
    <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-yellow-500 mb-4"></div>
            <p class="text-gray-400 text-sm">Lade Local Tracker...</p>
        </div>
    </div>

    <div id="app-content" class="hidden flex flex-col h-full">
        <header class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 z-20 shadow-md">
            <div class="flex items-center gap-2">
                <i data-lucide="users" class="w-6 h-6 text-yellow-400"></i>
                <h1 class="text-xl font-bold text-yellow-400">Local Tracker</h1>
            </div>
            <button onclick="window.location.href='homescreen.html'" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                <i data-lucide="home" class="w-5 h-5 text-white"></i>
            </button>
        </header>

        <div class="flex-grow overflow-y-auto p-4 w-full max-w-2xl mx-auto pb-20">
            
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 border border-gray-700">
                <form id="matchForm" class="space-y-4">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                            <label class="text-xs text-yellow-500 font-bold uppercase mb-1 block">Dein Deck</label>
                            <input type="text" id="ownDeckName" class="input-dark mb-2" required placeholder="Name (z.B. Ur-Dragon)" />
                            <div class="flex gap-2 justify-center" id="own-colors">
                                <div class="mana-symbol mana-w" data-c="W">W</div>
                                <div class="mana-symbol mana-u" data-c="U">U</div>
                                <div class="mana-symbol mana-b" data-c="B">B</div>
                                <div class="mana-symbol mana-r" data-c="R">R</div>
                                <div class="mana-symbol mana-g" data-c="G">G</div>
                            </div>
                        </div>

                        <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                            <label class="text-xs text-red-400 font-bold uppercase mb-1 block">Gegner Deck</label>
                            <input type="text" id="opponentDeckName" class="input-dark mb-2" required placeholder="Name (z.B. Atraxa)" />
                            <div class="flex gap-2 justify-center" id="opp-colors">
                                <div class="mana-symbol mana-w" data-c="W">W</div>
                                <div class="mana-symbol mana-u" data-c="U">U</div>
                                <div class="mana-symbol mana-b" data-c="B">B</div>
                                <div class="mana-symbol mana-r" data-c="R">R</div>
                                <div class="mana-symbol mana-g" data-c="G">G</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Gewonnen</label>
                            <input type="number" id="wins" class="input-dark text-center font-bold text-lg" value="0" min="0" required>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Verloren</label>
                            <input type="number" id="losses" class="input-dark text-center font-bold text-lg" value="0" min="0" required>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Format</label>
                            <select id="format" class="select-dark text-sm">
                                <option value="Commander">Commander</option>
                                <option value="Modern">Modern</option>
                                <option value="Standard">Standard</option>
                                <option value="Pauper">Pauper</option>
                                <option value="Draft">Draft</option>
                                <option value="Other">Andere</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded-lg font-bold shadow-lg transition-all active:scale-95">
                        Spiel protokollieren
                    </button>
                </form>
            </div>
            
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="font-bold text-lg text-white">Verlauf</h3>
                <span id="match-count" class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">0 Spiele</span>
            </div>
            
            <div id="history" class="space-y-3 pb-8">
                <p class="text-center text-gray-500 py-4 italic">Lade Verlauf...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyB2qmkKq4sYOXDd7mF-Mq1rnCWCfDAWXew", authDomain: "entons-game-tracker.firebaseapp.com", projectId: "entons-game-tracker", storageBucket: "entons-game-tracker.firebasestorage.app", messagingSenderId: "968932411080", appId: "1:968932411080:web:d391ffe5ecbd7852bc47fd", measurementId: "G-KB6JSFEPS1" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let user = null;
        let colors = { own: [], opp: [] };

        // Auth Check
        onAuthStateChanged(auth, (u) => {
            if(!u) {
                window.location.href = 'index.html';
            } else {
                user = u;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                lucide.createIcons();
                loadMatches();
            }
        });

        // Mana Color Logic
        const toggle = (el, type) => {
            const c = el.dataset.c;
            el.classList.toggle('mana-selected');
            if(colors[type].includes(c)) {
                colors[type] = colors[type].filter(x => x !== c);
            } else {
                colors[type].push(c);
            }
        };

        document.querySelectorAll('#own-colors .mana-symbol').forEach(el => el.onclick = () => toggle(el, 'own'));
        document.querySelectorAll('#opp-colors .mana-symbol').forEach(el => el.onclick = () => toggle(el, 'opp'));

        // Helper: Render Mana Symbols in History
        const renderManaRow = (colorArray) => {
            if (!colorArray || colorArray.length === 0) return '';
            return colorArray.map(c => {
                let bg = '';
                if(c==='W') bg='bg-[#F9F3B7] text-black';
                if(c==='U') bg='bg-[#3A62B7]';
                if(c==='B') bg='bg-[#1E1E1E]';
                if(c==='R') bg='bg-[#D64242]';
                if(c==='G') bg='bg-[#5B9567]';
                return `<span class="inline-block w-3 h-3 rounded-full ${bg} border border-white/20 mr-0.5"></span>`;
            }).join('');
        };

        // Submit Match
        document.getElementById('matchForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; 
            btn.innerText = "Speichere...";

            const wins = parseInt(document.getElementById('wins').value);
            const losses = parseInt(document.getElementById('losses').value);
            const format = document.getElementById('format').value;

            try {
                await addDoc(collection(db, 'users', user.uid, 'local_matches'), {
                    ownDeckName: document.getElementById('ownDeckName').value.trim(),
                    opponentDeckName: document.getElementById('opponentDeckName').value.trim(),
                    ownDeckColors: colors.own,
                    opponentDeckColors: colors.opp,
                    gamesWon: wins,
                    gamesLost: losses,
                    result: wins > losses ? 'Win' : (wins < losses ? 'Loss' : 'Draw'),
                    format: format,
                    timestamp: Date.now()
                });

                // Reset Form
                document.getElementById('ownDeckName').value = '';
                document.getElementById('opponentDeckName').value = '';
                document.getElementById('wins').value = '0';
                document.getElementById('losses').value = '0';
                document.querySelectorAll('.mana-selected').forEach(el => el.classList.remove('mana-selected'));
                colors = { own: [], opp: [] };
                
            } catch(err) {
                console.error(err);
                alert("Fehler beim Speichern!");
            } finally {
                btn.disabled = false;
                btn.innerText = "Spiel protokollieren";
            }
        };

        // Load & Render Matches
        const loadMatches = () => {
            const q = query(collection(db, 'users', user.uid, 'local_matches'), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('history');
                document.getElementById('match-count').innerText = `${snapshot.size} Spiele`;

                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-8">Keine lokalen Spiele gefunden.<br>Spiel dein erstes Match!</div>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const m = doc.data();
                    const isWin = m.result === 'Win';
                    const isDraw = m.result === 'Draw';
                    
                    let borderClass = isWin ? 'border-green-500' : 'border-red-500';
                    let textClass = isWin ? 'text-green-400' : 'text-red-400';
                    if(isDraw) { borderClass = 'border-gray-500'; textClass = 'text-gray-400'; }

                    const date = new Date(m.timestamp).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'});

                    return `
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 ${borderClass} shadow-md hover:bg-gray-750 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-white text-base">${m.ownDeckName} <span class="text-gray-500 font-normal text-xs">vs</span> ${m.opponentDeckName}</div>
                                <div class="flex items-center mt-1 space-x-2">
                                    <div class="flex">${renderManaRow(m.ownDeckColors)}</div>
                                    <span class="text-gray-600 text-xs">|</span>
                                    <div class="flex">${renderManaRow(m.opponentDeckColors)}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-xl ${textClass}">${m.gamesWon}:${m.gamesLost}</div>
                                <div class="text-xs text-gray-500 bg-gray-900 px-1.5 py-0.5 rounded mt-1 inline-block">${m.format || 'Casual'}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 text-right">${date}</div>
                    </div>`;
                }).join('');
            });
        };
    </script>
</body>
</html>