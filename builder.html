<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commander Deck Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body, html { height: 100%; overflow: hidden; overscroll-behavior: none; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #eab308; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dragging-ghost { position: fixed; z-index: 1000; opacity: 0.85; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans flex flex-col h-screen">

    <div id="app-root" class="flex-grow flex flex-col h-full overflow-hidden">
        <div class="h-full flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-400">Loading Cloud Builder...</p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2qmkKq4sYOXDd7mF-Mq1rnCWCfDAWXew",
            authDomain: "entons-game-tracker.firebaseapp.com",
            projectId: "entons-game-tracker",
            storageBucket: "entons-game-tracker.firebasestorage.app",
            messagingSenderId: "968932411080",
            appId: "1:968932411080:web:d391ffe5ecbd7852bc47fd",
            measurementId: "G-KB6JSFEPS1"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.db = db;
        window.fb = { collection, doc, setDoc, getDocs, deleteDoc };

        const renderHeader = (user) => {
            const displayName = user.displayName || user.email.split('@')[0];
            return `
                <header class="bg-gray-800 shadow-md p-4 flex-shrink-0 z-50 border-b border-gray-700">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <h1 class="text-2xl font-bold text-blue-400">Deck Builder</h1>
                            <button onclick="window.location.href='homescreen.html'" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600"><i data-lucide="home" class="w-5 h-5 text-white"></i></button>
                        </div>
                        <div class="text-right text-sm">
                            <span class="font-semibold text-white">${displayName}</span>
                            <button onclick="window.auth.signOut().then(()=>window.location.href='index.html')" class="ml-4 text-red-400 text-xs">Logout</button>
                        </div>
                    </div>
                </header>
            `;
        };

        window.auth = auth;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const root = document.getElementById('app-root');
                root.innerHTML = renderHeader(user) + '<div id="react-content" class="flex-grow overflow-y-auto scrollbar-thin p-4"></div>';
                lucide.createIcons();
                if (typeof App !== 'undefined') {
                    const reactRoot = ReactDOM.createRoot(document.getElementById('react-content'));
                    reactRoot.render(React.createElement(App, { user: user }));
                } else {
                    setTimeout(() => {
                        const reactRoot = ReactDOM.createRoot(document.getElementById('react-content'));
                        reactRoot.render(React.createElement(App, { user: user }));
                    }, 500);
                }
            } else { window.location.href = 'index.html'; }
        });
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const generateId = () => Math.random().toString(36).substring(2, 9);
        const SCRYFALL_API = 'https://api.scryfall.com';

        const DeckCard = ({ card, onDelete, actionLabel, onMove }) => {
            const img = card.image_url || 'https://placehold.co/200x280?text=No+Image';
            return (
                <div className="relative group aspect-[5/7] bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-yellow-500 shadow-md transition-all">
                    <img src={img} className="w-full h-full object-cover" loading="lazy" />
                    <button onClick={onDelete} className="absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 z-10">&times;</button>
                    <div className="absolute bottom-0 inset-x-0 p-1 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onClick={onMove} className="w-full text-[10px] bg-blue-600 text-white py-1 rounded">{actionLabel}</button>
                    </div>
                </div>
            );
        };

        const CardSearchModal = ({ isOpen, onClose, onAdd }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);

            if (!isOpen) return null;
            
            const search = async () => {
                if(!query) return;
                setLoading(true);
                try {
                    const res = await fetch(`${SCRYFALL_API}/cards/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    setResults(data.data || []);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                    <div className="bg-gray-800 w-full max-w-3xl h-[80vh] rounded-xl flex flex-col p-4">
                        <div className="flex justify-between mb-4"><h2 className="text-xl font-bold text-white">Add Card</h2><button onClick={onClose} className="text-gray-400">X</button></div>
                        <div className="flex gap-2 mb-4">
                            <input value={query} onChange={e=>setQuery(e.target.value)} onKeyDown={e=>e.key==='Enter'&&search()} className="flex-grow bg-gray-900 border border-gray-700 p-2 rounded text-white" placeholder="Search..." />
                            <button onClick={search} className="bg-blue-600 px-4 rounded text-white">{loading ? '...' : 'Search'}</button>
                        </div>
                        <div className="flex-grow overflow-y-auto grid grid-cols-3 md:grid-cols-5 gap-2">
                            {results.map(card => (
                                <div key={card.id} onClick={() => { onAdd({ ...card, id: generateId(), image_url: card.image_uris?.normal || card.card_faces?.[0]?.image_uris?.normal }); onClose(); }} className="cursor-pointer hover:opacity-80">
                                    <img src={card.image_uris?.small || card.card_faces?.[0]?.image_uris?.small} className="rounded" />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = ({ user }) => {
            const [decks, setDecks] = useState([]);
            const [currDeck, setCurrDeck] = useState(null);
            const [isSearchOpen, setIsSearchOpen] = useState(false);
            
            const db = window.db;

            useEffect(() => {
                const load = async () => {
                    const snap = await window.fb.getDocs(window.fb.collection(db, 'users', user.uid, 'decks'));
                    const d = snap.docs.map(x => x.data());
                    setDecks(d);
                    if(d.length) setCurrDeck(d[0]);
                    else {
                        const newD = { id: generateId(), name: 'New Deck', cards: [], commander: null, sideboard: [] };
                        await window.fb.setDoc(window.fb.doc(db, 'users', user.uid, 'decks', newD.id), newD);
                        setDecks([newD]); setCurrDeck(newD);
                    }
                };
                load();
            }, []);

            const save = async (d) => {
                setCurrDeck(d);
                setDecks(prev => prev.map(x => x.id === d.id ? d : x));
                await window.fb.setDoc(window.fb.doc(db, 'users', user.uid, 'decks', d.id), d);
            };

            const addCard = (c) => save({ ...currDeck, cards: [c, ...currDeck.cards] });
            const removeCard = (id) => save({ ...currDeck, cards: currDeck.cards.filter(x => x.id !== id) });

            if (!currDeck) return <div className="text-white text-center mt-10">Loading...</div>;

            return (
                <div className="max-w-7xl mx-auto w-full pb-20">
                    <CardSearchModal isOpen={isSearchOpen} onClose={()=>setIsSearchOpen(false)} onAdd={addCard} />
                    
                    <div className="mb-6 flex gap-4 items-center flex-wrap">
                        <select value={currDeck.id} onChange={e => setCurrDeck(decks.find(x => x.id === e.target.value))} className="bg-gray-800 text-white p-2 rounded border border-gray-700">
                            {decks.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                        </select>
                        <button onClick={() => setIsSearchOpen(true)} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded font-bold">+ Add Card</button>
                        <span className="text-gray-400 ml-auto">{currDeck.cards.length} Cards</span>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        {currDeck.cards.map(c => (
                            <DeckCard key={c.id} card={c} onDelete={() => removeCard(c.id)} actionLabel="Move" onMove={() => {}} />
                        ))}
                    </div>
                </div>
            );
        };
    </script>
</body>
</html>